{% extends "base.html" %}
{% block content %}
<h2>Season Dashboard</h2>

<div class="card-row">
  <div class="card">
    <h3>Last updated GW</h3>
    <p class="big">{{ season.last_updated_gw if season else 'N/A' }}</p>
  </div>

  <div class="card">
    <h3>Top scorer (season)</h3>
    {% if season and season.leaders and season.leaders.top_scorers %}
      <p>
        {{ season.leaders.top_scorers[0].name }} â€”
        {{ season.leaders.top_scorers[0].value }}
      </p>
    {% else %}
      <p>N/A</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>Most MVPs</h3>
    {% if season and season.leaders and season.leaders.most_mvps %}
      <p>
        {{ season.leaders.most_mvps.names | join(', ') }}
        ({{ season.leaders.most_mvps.count }})
      </p>
    {% else %}
      <p>N/A</p>
    {% endif %}
  </div>
</div>

<section>
  <h3>Goals / Gameweek (analytics)</h3>
  <div style="height:260px;">
    <canvas id="goalsChart" height="260"></canvas>
  </div>
</section>

<section>
  <h3>Recent Gameweeks</h3>
  <div class="grid">
    {% if recent %}
      {% for a in recent %}
        <a class="gw-card" href="/gameweek/{{ a.gameweek }}">
          <h4>GW {{ a.gameweek }}</h4>
          <p><strong>MVP:</strong> {{ a.mvp.name }} ({{ a.mvp.points }})</p>
          <p>
            <strong>Top scorers:</strong>
            {% if a.top_scorers %}
              {{ a.top_scorers | map(attribute='name') | list | join(', ') }}
            {% else %}
              N/A
            {% endif %}
          </p>
        </a>
      {% endfor %}
    {% else %}
      <p>No recent gameweek summaries available.</p>
    {% endif %}
  </div>
</section>

<script>
  // Inject analytics safely as a JSON string and parse it so the editor and runtime are happy
  const analyticsData = JSON.parse(`{{ analytics | tojson | safe }}`);

  // Ensure array
  const analyticsArr = Array.isArray(analyticsData) ? analyticsData : [];

  // Sort ascending by GW number (defensive)
  analyticsArr.sort((a, b) => (a.gameweek || 0) - (b.gameweek || 0));

  // Build labels and derived goals metric (sum of team_stats.most_goals_scored values if present)
  const labels = analyticsArr.map(a => 'GW ' + (a.gameweek || 'N/A'));
  const goals = analyticsArr.map(a => {
    try {
      const mg = (a.team_stats && a.team_stats.most_goals_scored) ? a.team_stats.most_goals_scored : [];
      let total = 0;
      mg.forEach(x => { total += (x.value || 0); });
      return total;
    } catch (e) {
      return 0;
    }
  });

  (function initGoalsChart() {
    const canvas = document.getElementById('goalsChart');
    if (!canvas || typeof Chart === 'undefined') return;

    const ctx = canvas.getContext('2d');

    // Destroy old instance (useful during dev hot reloads)
    if (canvas._chartInstance) {
      canvas._chartInstance.destroy();
    }

    canvas._chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Derived goals (sum of top teams)',
          data: goals,
          borderWidth: 1,
          // leave colors to browser defaults; you can set colors here if you want
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { mode: 'index', intersect: false }
        }
      }
    });
  })();
</script>
{% endblock %}